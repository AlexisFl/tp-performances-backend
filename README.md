# TP Optimisation des Performances Backend

Comp√©tences mobilis√©es :
- Optimisations SQL (nombre de requ√™tes, structuration des tables, ...)
- Mise en place de syst√®mes de caches vari√©s
- Analyse des performances avec Timing API
- Analyse des performances avec APM NewRelic
- Configuration NGINX
- Optimisation du code PHP

Vous allez travailler sur une application de moteur de recherche d'h√¥tel (un peu √† la AirBnB mais en moins bien). La version dont vous disposez est largement sous-optimis√©e, pour ne pas dire catastrophique. Tout au long du TP, vous allez travailler pour am√©liorer les performances de cette derni√®re.

### Mise en route du TP & Explications
[Voir les instructions](/docs/setup.md)


### ‚ö†Ô∏è ATTENTION ‚ö†Ô∏è
Pour chaque question num√©rot√©e, vous devrez effectuer un commit pour que je puisse √©valuer votre travail. Vous verrez des rappels ("COMMIT") entre les questions concern√©es.

Vous cr√©erez √©galement un fichier "TP.md" qui vous servira de compte rendu o√π vous noterez certaines r√©ponses aux questions et que vous versionnerez sur Git. Les questions mentionneront explicitement quelles informations sont attendues dans ce compte rendu.

L'application √©tant tr√®s lente au d√©but, vous √™tes autoris√© √† ajouter `LIMIT 10` √† la fin de la requ√™te au d√©but de `App\Services\Hotel\UnoptimizedHotelService::list()`. **Vous devrez cependant retirer cette limite lors de vos mesures pour le compte rendu**.

## Partie 1 : Faire fonctionner l'application
- D√©compressez l'archive `src/assets/images.zip` pour avoir un dossier `src/assets/images`.
- Lancez Docker avec la commande `docker compose up`
- Ouvrez PHPMyAdmin sur `http://localhost:8080` et importez le fichier `./database.sql.gz` dans la base de donn√©es `tp`.
- Dans Docker Desktop, acc√©dez au terminal du container `backend` et lancez la commande `composer install`
- Ouvrez l'application sur `http://localhost`

## Partie 2 : Mesurer les performances

1. **Installez l'extension navigateur [*Page load time*](https://chrome.google.com/webstore/detail/page-load-time/fploionmjgeclbkemipmkogoaohcdbig) et affichez-la constamment dans votre navigateur (sur Chrome cliquez sur l'ic√¥ne puzzle en haut √† droite et cliquez sur l'ic√¥ne punaise)**. ![](docs/assets/screenshot-pin-chrome-ext.png)

2. Vous disposez d'une classe utilitaire `src/Common/Timers.php`. Elle permet d'effectuer des mesures de performances de certaines portions de code et de les visualiser dans le navigateur.
- **Ouvrez le fichier `src/Common/Timers.php` et observez les commentaires de documentation pour comprendre comment fonctionne cette classe.**
- **Utilisez cette classe pour mesurer les temps d'ex√©cution de 3 m√©thodes qui vous semblent particuli√®rement consommatrices de ressources dans le service `src/Services/Hotel/UnoptimizedHotelService.php`**. 
- Pour consulter les temps mesur√©s, ouvrez vos ChromeDevTools (Chrome, Brave, Edge, ...) et dans l'onglet "Network", cliquez sur le type "Doc". Cliquez sur la ligne
  `localhost` (dans la colonne `name` sinon √ßa ne marchera pas) et dans la fen√™tre qui s'affiche, consultez l'onglet "Timing", puis observez la section "Server Timing".
- **Indiquez dans votre compte rendu le nom de ces m√©thodes et leur temps d'ex√©cution sur une requ√™te**.

> [‚ÑπÔ∏è Indice : Comment bien choisir les fonctions √† analyser](/docs/question-2-indices.md)

**<div style="text-align:center">COMMIT</div>**

## Partie 3 : Optimiser la base de donn√©es

![](docs/assets/singleton-db.png)

3. **Tout d'abord, r√©duisez le nombre de connexions `PDO` dans votre application.**
- Commencez par **ajouter un timer sur la m√©thode `UnoptimizedHotelService::getDB()` et notez le temps qu'elle prend dans votre compte rendu.** Remarquez aussi son nombre d'appels : c'est autant de connexions `PDO` qui sont ouvertes !
- Deux de vos services les utilisent `UnoptimizedHotelService` et `RoomService`, **vous allez donc devoir cr√©er un Singleton <u>sans utiliser le `SingletonTrait`</u> pour votre base de donn√©es et l'utiliser dans vos deux services.**
- **Notez dans votre compte rendu par combien vous avez am√©lior√© le temps de chargement de la page** ainsi que **le nouveau temps enregistr√© pour la m√©thode `UnoptimizedHotelService::getDB()`.**
  
**<div style="text-align:center">COMMIT</div>**

4. *Lisez jusqu'au bout avant de commencer !*
- **Analysez le code du `UnoptimizedHotelService` et rep√©rez certaines portions de code qui pourraient √™tre faite en SQL**. (*3 m√©thodes sont concern√©es, mais une est diff√©rente de celles trouv√©es √† la question 2 ! M√™me si elle est proche*). 
- N'h√©sitez pas √† tester vos requ√™tes dans PHPMyAdmin avant de les mettre dans votre code PHP, vous gagnerez beaucoup de temps, sachant que la page est longue √† charger !
- **Impl√©mentez ces requ√™tes dans le service et contr√¥lez que vos filtres fonctionnent avec les valeurs de l'image contr√¥le (voir lien). Vous devriez avoir le m√™me r√©sultat apr√®s avoir saisi les m√™mes valeurs de filtre :** [Contr√¥le des r√©sultats de filtre üèû](docs/assets/controle-resultats-q5.png) (retirez bien le `LIMIT 10` !).
- **Dans votre compte rendu, saisissez le code SQL initial et son temps d'ex√©cution gr√¢ce √† vos `Timers`, puis notez vos nouvelles requ√™tes et leur temps d'ex√©cution**. 

> - [‚ÑπÔ∏è Indice : Comment obtenir plusieurs valeurs des tables `meta` dans la m√™me requ√™te ?](/docs/question-5-indices.md)
> - [‚ÑπÔ∏è Indice : Comment g√©rer l'√©criture des `WHERE` en fonction des conditions de `$args` ?](/docs/question-5-indices.md)

**<div style="text-align:center">COMMIT</div>**

5. En analysant le code et en vous aidant des `Timers` :
- **Trouvez quelle m√©thode de `UnoptimizedHotelService` est appel√© un grand nombre de fois (10x par h√¥tel affich√© !).**
- **R√©√©crivez-la en m√™lant SQL et PHP pour diviser le nombre total de requ√™tes SQL par 3** (*vous devrez peut-√™tre supprimer une m√©thode*).
- **Notez dans votre compte rendu le nombre de requ√™tes SQL avant et apr√®s votre modification, ainsi que les diff√©rences de temps de chargement**.

**<div style="text-align:center">COMMIT</div>**

6. En exploitant le code SQL et PHP que vous avez √©crit √† la question 4, **cr√©ez un nouveau service `OneRequestHotelService` qui sera en mesure de requ√™ter les h√¥tels avec les filtres en <u>1 seule requ√™te SQL</u>**.

> - [‚ÑπÔ∏è Indice : Utiliser des sous-requ√™tes dans les `INNER JOIN`](/docs/question-6-indice.md)
> - [‚ÑπÔ∏è Indice : Calculer une distance entre deux points GPS en SQL](/docs/question-6-indice.md)

**<div style="text-align:center">COMMIT</div>**

7. **Inspectez la structure des tables de la base de donn√©es.** Outre le fait que les types soient horribles, il n'y a surtout aucun index. Maintenant que vous avez ajout√© des conditions SQL, vous devriez savoir sur quelles colonnes ajouter des indexes pour am√©liorer les performances. 
- **Notez dans votre compte rendu les colonnes que vous avez choisies pour ajouter les indexes**
- **Mesurez le temps de chargement de la page avant d'ajouter vos indexes**
- **√âcrivez dans votre compte rendu la requ√™te SQL pour ajouter vos indexes** (*Lorsque vous reprendrez le TP sur un autre poste vous serez bien content de pouvoir CTRL+C CTRL+V la cr√©ation des indexes*)
- **Mesurez et consignez le nouveau temps de chargement apr√®s ex√©cution de la requ√™te d'ajout des indexes**

**<div style="text-align:center">COMMIT</div>**

8. *Le moment que vous attendiez tous* :
- En vous basant sur la structure des classes `HotelEntity` et `RoomEntity`, **cr√©ez deux nouvelles tables (`hotels` et `rooms`) en base donn√©es dont la structure est optimis√©e pour r√©duire le nombre de requ√™tes n√©cessaires √† l'affichage des donn√©es. Portez une attention particuli√®re aux types des donn√©es et n'oubliez pas d'ajouter les indexes.**
- **√âcrivez dans votre compte rendu la requ√™te SQL de cr√©ation des tables.**
- **Remplissez les tables √† partir des donn√©es obtenues par la grosse requ√™te SQL que vous avez √©crite dans la question pr√©c√©dente et notez dans votre compte rendu la requ√™te SQL utilis√©e**.
- **√âcrivez un nouveau service `ReworkedHotelService`** 
- **Comparez et notez dans votre compte rendu les diff√©rences de temps de chargement entre ces deux services**

> [‚ÑπÔ∏è Indice : Comment g√©n√©rer la requ√™te SQL de cr√©ation d'une table ?](docs/question-8-indice.md)

**<div style="text-align:center">COMMIT</div>**

## Partie 4 : Mise en cache

Les responsables marketing de l'entreprise vous demandent de ne plus charger les avis des h√¥tels depuis votre base de donn√©es actuelle. Ils souhaitent utiliser un service tiers de d'avis (comme *Avis v√©rifi√©s* ou *Trustpilot*) afin de mettre les internautes plus en confiance. Probl√®me, ce service est gratuit et les serveurs sont de pi√®tre qualit√© et lents √† r√©pondre, mais vous n'avez pas d'autre choix que d'utiliser ce service sur lequel **vous n'avez aucun contr√¥le sur le code**.

9. **Cr√©ez un service `App\Services\Reviews\APIReviewsService` en vous basant sur le sch√©ma UML ci-dessus. Au sein de ce dernier, vous effectuerez des requ√™tes HTTP depuis PHP pour charger les avis de vos h√¥tels via l'API mise √† disposition par le service *CheapTrustedReviews*. Vous utiliserez ensuite ce service dans votre service d'h√¥tel. Notez dans votre compte rendu les diff√©rences de temps de chargement qu'entra√Ænent l'utilisation de cette API.**
- Bien √©videmment, *CheapTrustedReviews* n'existe pas IRL (du moins je l'esp√®re), mais vous pouvez y acc√©dez <u>depuis l'int√©rieur d'un container Docker du TP</u> √† l'url `http://cheap-trusted-reviews.fake/`.
- Pour r√©cup√©rer un avis d'h√¥tel, utilisez l'URL `http://cheap-trusted-reviews.fake/?hotel_id={hotelId}` qui vous retournera pour un h√¥tel donn√© un objet JSON comme ceci : 
```json
{
  "rating" : 4.33333333333,
  "count" : 348
}
```
**<div style="text-align:center">COMMIT</div>**

10. Si vous avez laiss√© vos timers de la question 2., vous devriez savoir quelles sont les 3 grosses m√©thodes qui sont consommatrices de ressources. **Impl√©mentez un syst√®me de cache pour r√©duire l'occurrence de ces calculs. Notez dans votre compte rendu l'am√©lioration du temps de la requ√™te**.
- Installez la librairie [Symfony Cache](https://symfony.com/doc/current/components/cache.html) en suivant les instructions de la page. Pour avoir acc√®s √† Composer, utilisez le container Docker `backend` en allant dans l'onglet "*terminal*" de Docker Desktop sur la page du container. *Pro tips : utilisez la commande `bash` pour avoir un meilleur terminal (navigation au clavier, historique de commandes, couleurs, autocompletion, ...)*.
- Cr√©ez une classe `App\Common\Cache` en suivant l'approche Singleton et en vous basant sur le sch√©ma UML ci-dessus. (*La classe `AdapterInterface` est dans le namespace `Symfony\Component\Cache\Adapter`*).
- **Param√©trez un cache bas√© sur Redis. Vous trouverez la documentation n√©cessaire sur la page [Redis Cache Adapter](https://symfony.com/doc/current/components/cache/adapters/redis_adapter.html)**. L'h√¥te de la base Redis n'est pas `localhost` mais `redis` dans notre contexte Docker compose. Votre DSN devrait donc √™tre `redis://redis`.
- **N'utilisez pas directement votre Singleton `Cache` dans votre service. Cr√©ez plut√¥t un nouveau service `CachedHotelService` qui h√©rite de `UnoptimizedHotelService` et surchargez les m√©thodes que vous voulez mettre en cache (n'h√©sitez pas √† appeler la m√©thode du parent !)**.
- Dans `index.php`, **utilisez `CachedHotelService` si le param√®tre `skip_cache` n'est pas pr√©sent dans l'URL**.
- **Notez dans votre compte rendu les diff√©rences de temps de chargement entre `http://localhost` et `http://localhost?skip_cache`** (n'oubliez pas que le cache ne sera pris en compte qu'√† partir de la seconde requ√™te !)
> **ATTENTION** : vous devez choisir avec soin quelles donn√©es seront mises en cache. Toutes ne doivent pas l'√™tre, car elles peuvent √™tre chang√©es en fonction des valeurs saisies dans les filtres. Vous ne pouvez par exemple pas mettre toute la m√©thode `list()` en cache. Mais si vous avez bien fait votre travail √† la question 2, vous savez quelles donn√©es mettre en cache. Vous devez √©galement avoir des cl√©s de cache uniques, tirez parti par exemple de l'ID de l'h√¥tel.

**<div style="text-align:center">COMMIT</div>**

## Partie 5 : Optimisations NGINX 

11. Param√©trez une compression GZIP pour vos transmissions client/serveur, notez le poids du fichier CSS avant compression et apr√®s
12. Ajoutez √©galement une compression Brotli, comparez le poids des fichiers CSS, notez le poids du fichier CSS et comparez le avec GZIP
13. Param√©trez un cache HTTP pour les ressources statiques (images, CSS, JS, ...)
14. Effectuez une modification CSS et constatez que vous ne vous ne l'avez plus dans le navigateur. Ajoutez une constante de version d'application que vous ajouterez √† la fin des URL d'appels de vos fichiers statiques
15. Param√©trez un cache Proxy, comparez les temps de performance. 

## Partie 6 : Bonus

16. Ajoutez le param√®tre lazy-loading sur vos images 